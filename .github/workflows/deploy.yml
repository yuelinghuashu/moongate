name: Deploy to Aliyun

on: push

jobs:
  ci:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest]
        node: [22]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install system dependencies for SQLite
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 libsqlite3-dev

      - name: Install dependencies
        run: pnpm install
        
      - name: Lint
        run: pnpm run lint

      - name: Build with custom env
        env:
          # ğŸ‘‡ å…³é”®ï¼šè¦†ç›– CI ç¯å¢ƒå˜é‡
          CI: false
          NODE_ENV: production
          # ğŸ‘‡ ç¡®ä¿ Nitro ä½¿ç”¨æ­£ç¡®é¢„è®¾
          NITRO_PRESET: node-server
        run: pnpm run build

      - name: Check build output
        run: |
          echo "æ£€æŸ¥æ„å»ºè¾“å‡º..."
          find .output -name "*.sqlite" -o -name "*.db" | head -5
          ls -la .output/server/node_modules/.cache/nitro/ 2>/dev/null || true

      - name: Deploy to Server via Rsync
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avz --delete
          path: .output/
          remote_path: /var/www/my-site/
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Start/Reload Node.js service
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ å¯åŠ¨ Node.js SSR æœåŠ¡..."
            cd /var/www/my-site

            # ç¡®ä¿æœ‰æ­£ç¡®çš„æ–‡ä»¶æƒé™
            chown -R www-data:www-data .output 2>/dev/null || true
            chmod -R 755 .output 2>/dev/null || true

            # å¯åŠ¨æˆ–é‡å¯ Nuxt åº”ç”¨
            if pm2 describe nuxt-app > /dev/null 2>&1; then
              echo "ğŸ”„ é‡å¯ç°æœ‰åº”ç”¨..."
              pm2 reload nuxt-app --update-env
            else
              echo "ğŸš€ å¯åŠ¨æ–°åº”ç”¨..."
              pm2 start .output/server/index.mjs --name "nuxt-app" \
                --log /var/log/nuxt-app.log \
                --error /var/log/nuxt-app-error.log \
                --output /var/log/nuxt-app-out.log \
                --time
              
              pm2 save
            fi

            echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"
            pm2 status nuxt-app